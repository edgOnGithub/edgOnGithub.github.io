---
output: 
  html_document:
    code_folding: show
    highlight: kate
    theme: paper
editor_options:
  chunk_output_type: console
---

```{r}
library(readr)
library(dplyr)
library(skimr)
oyster <- read_csv('assets/Original Data/Nov09JnyExport.csv') 
oyster_underground <- oyster %>% 
  filter(SubSystem == "LUL")
rm(oyster)
gc()

oyster_underground <- oyster_underground %>% 
  filter(StartStn != "Unstarted") %>% 
  select(-SubSystem)
oyster_underground %>% 
  skim()
oyster_underground %>% 
  head()
library(forcats)
oyster_underground$daytype <- factor(oyster_underground$daytype, c("Mon",
                                                                   "Tue",
                                                                   "Wed",
                                                                   "Thu",
                                                                   "Fri",
                                                                   "Sat",
                                                                   "Sun"))
oyster_underground$downo
```


```{r}


library(plotly)

p <- plot_ly(oyster_underground %>% 
               filter(daytype == "Mon"),
             x = ~EntTimeHHMM %>% 
               as.POSIXct(),
             type = 'histogram')
p

q <- plot_ly(oyster_underground %>%
               filter(daytype == "Mon") %>% 
               filter(ExTime > 200),
             x = ~EXTimeHHMM %>% 
               as.POSIXct(),
             type = "histogram")
q


pq <- plot_ly(oyster_underground %>%
                filter(daytype == "Mon") %>% 
                filter(ExTime > 200),
              alpha = 0.4) %>% 
  add_histogram(x = ~EntTimeHHMM %>% 
                  as.POSIXct(),
                name = "Tap in time") %>% 
  add_histogram(x = ~EXTimeHHMM %>% 
                  as.POSIXct(),
                name = "Tap out time") %>% 
  layout(barmode = "overlay",
         xaxis = list(title = "Time"),
         title = "Histogram of Tube Journeys on Monday")
pq

library(lubridate)
oyster_underground_lubridate <- oyster_underground %>% 
  mutate(entry_datetime = EntTimeHHMM %>% 
           as.POSIXct() %>% 
           ymd_hms(),
         exit_datetime = EXTimeHHMM %>% 
           as.POSIXct() %>% 
           ymd_hms(),
         journey_time = interval(entry_datetime, exit_datetime) %>% 
           time_length(unit = "minute")) %>% 
  filter(journey_time > 0)

oyster_j_time <- oyster_underground_lubridate %>% 
  group_by(entry_datetime, daytype, downo) %>% 
  summarise(average_journey = mean(journey_time))

oyster_j_time_5 <- oyster_j_time %>% 
  mutate(five_min = round_date(entry_datetime, unit = "5 min")) %>% 
  group_by(five_min, daytype, downo) %>% 
  summarise(average_journey_5 = mean(average_journey))
  

oyster_j_time_5 %>% 
  plot_ly(x = ~five_min,
          y = ~average_journey_5,
          colors = "Set2",
          color = ~daytype) %>% 
  add_markers()

library(ggplot2)
oyster_j_time_5$downo <- as.factor(oyster_j_time_5$downo)
levels(oyster_j_time_5$downo) <- c("Sunday",
                                "Monday",
                                "Tuesday",
                                "Wednesday",
                                "Thursday",
                                "Friday",
                                "Saturday")
p <- ggplot(oyster_j_time_5 %>% 
              arrange(downo), aes(five_min, log(average_journey_5), color = daytype)) +
  geom_line() +
  facet_wrap(~downo, ncol = 1) +
  theme_minimal() +
  theme(legend.position = "none")
p %>% ggplotly


stations_data <- oyster_underground_lubridate %>% 
  group_by(StartStn, EndStation) %>% 
  summarise(n = n(),
            ave_time = mean(journey_time, na.rm = TRUE),
            FFare_mean = mean(FFare, na.rm = TRUE)) %>% 
  arrange(-n)

```

```{r}
library(tidygraph)
stations_filtered <- stations_data %>%
  filter(n > 300)
stations_filtered
library(tidyr)


oyster_graph <- as_tbl_graph(stations_filtered, directed  = FALSE)

library(ggraph)


ggraph(oyster_graph, layout = "linear", circular = TRUE) + 
    geom_edge_arc(aes(width = n, color = n), alpha = 0.2) + 
    guides(edge_width = 'none') +
    geom_node_text(aes(label = name), size = 3, repel = FALSE) +
    scale_color_brewer(palette = "Set1") +
    theme_graph() +
  ggtitle("Most Common Tube Journeys")


ggraph(oyster_graph) + 
    geom_edge_link(aes(width = n, color = n), alpha = 0.2) + 
    guides(edge_width = 'none') +
    geom_node_text(aes(label = name), size = 3, repel = TRUE) +
    scale_color_brewer(palette = "Set1") +
    theme_graph()


ggraph(oyster_graph) + 
    geom_edge_fan(aes(width = n, color = n), alpha = 0.2,
                  spread = 2,
                  arrow = arrow(length = unit(2, 'mm')), 
                   end_cap = circle(2, 'mm')) + 
    guides(edge_width = 'none') +
    geom_node_text(aes(label = name), size = 3, repel = FALSE) +
    scale_color_brewer(palette = "Set2") +
    theme_graph()

```


```{r}
switched_df <- stations_filtered %>% 
  unite(col = station_pair, EndStation, StartStn, remove = FALSE)
switched_df

station_usage <- stations_filtered %>% 
  unite(col = station_pair, StartStn, EndStation, remove = FALSE) %>% 
  ungroup() %>% 
  select(station_pair, n, StartStn, EndStation) %>% 
  inner_join(y = switched_df %>% 
               ungroup() %>% 
               select(station_pair, n), by = 'station_pair') %>% 
  mutate(summed_journeys = n.x + n.y)

station_usage

stations_filtered_journeys <- stations_filtered %>% 
  left_join(y = station_usage %>% 
              select(StartStn, EndStation,summed_journeys), by = c("StartStn", "EndStation")) 

oyster_journeys <- stations_filtered_journeys %>% 
  as_tbl_graph(directed = FALSE)


ggraph(oyster_journeys, layout = "fr") + 
    geom_edge_fan(aes(width = summed_journeys, color = n), alpha = 0.2) + 
    guides(edge_width = 'none') +
    geom_node_text(aes(label = name), size = 3, repel = FALSE) +
    scale_color_brewer(palette = "Set1") +
    theme_graph()
```



```{r}



stations_data
oyster_underground_lubridate %>% 
  filter(StartStn == "Waterloo JLE") %>% 
  ggplot(aes(x = EntTime)) +
  geom_histogram() +
  facet_wrap(~daytype) +
  theme_minimal()



stan_data <- oyster_underground_lubridate %>%
  filter(StartStn == "Waterloo JLE") %>% 
  filter(daytype != "Sat" | daytype != "Sun") %>% 
  group_by(EntTimeHHMM, EntTime) %>% 
  summarise(y = n()) %>% 
  mutate(post_lunch = ifelse(test = (EntTimeHHMM >= hms("12:00:00")),
                             1, 2))

stan_data


stan_data %>% 
  ggplot(aes(x = EntTimeHHMM, y = y)) +
  geom_point() +
  theme_minimal()


ed <- lm(data = stan_data,formula =  y ~ EntTime)
ed %>% summary()

library(rstanarm)
options(mc.cores = parallel::detectCores())
ed_two <- stan_glmer(data = stan_data,
                   y ~ 1 | post_lunch)

ed_two %>% launch_shinystan()

library(rstan)
library(shinystan)

stan_data_list <- list(y = stan_data$y,
               N = nrow(stan_data),
               id = stan_data$post_lunch,
               L = 2)

model <- stan('_posts/waterloo_footfall_hierarchical_2.stan',
              data = stan_data_list,
              control = list(adapt_delta = 0.999))

model %>% launch_shinystan()


  

```
