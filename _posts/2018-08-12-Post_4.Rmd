---
output: 
  html_document:
    code_folding: show
    highlight: kate
    theme: paper
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE,
                      warning = FALSE)
library(dplyr)
MRW_clean <- readr::read_csv('assets/Transformed Data/MRW_appendix_clean.csv') %>% 
  mutate(n_g_d = (working_age_pop_ch + 5)/ 100,
         s = s / 100)
library(broom)
collect.results <- function(models, names){
  
  results <- map2_dfr(.x = models,
                      .y = names,
                      .f = function(x, y){tidy(x) %>% mutate(subset = y)}) %>% 
    as_tibble()
  return(results)
}
```

```{r, table_1}
library(purrr)
library(tidyr)

MRW_clean_restricted <- MRW_clean %>% 
  mutate(restricted_regressor = log(s) - log(n_g_d))
restricted_models <- c('N',
                      'I',
                      'O') %>% 
  map(sym) %>% 
  map(~filter(MRW_clean_restricted, !!. == 1)) %>% 
  map(~lm(log(`1985`) ~ restricted_regressor,
                       data = .)) 



```

```{r}
  

restricted_model_results <- restricted_models %>% 
  collect.results(., names = c("OECD Restricted Classic",
                               "Intermediate Restricted Classic",
                               "Non-Oil Restricted Classic"))

calculate.alpha <- function(estimate){
  alpha <- estimate / (1 + estimate)
  return(alpha)
}
restricted_model_results <- restricted_model_results %>% 
  mutate(alpha = ifelse((term == 'restricted_regressor'), calculate.alpha(estimate), NA))

## Augmented model
MRW_augmented_restricted <- MRW_clean_restricted %>% 
  mutate(restricted_regressor_hc = log(school / 100) - log(n_g_d))

augmented_restricted_model <- c("O",
                                "I",
                                "N") %>% 
  map(sym) %>% 
  map(~filter(MRW_augmented_restricted, !!. == 1)) %>% 
  map(~lm(log(`1985`) ~ restricted_regressor + restricted_regressor_hc,
          data = .)) %>% 
  collect.results(., names = c("OECD Restricted Augmented",
                               "Intermediate Restricted Augmented",
                               "Non-Oil Restricted Augmented"))


find.param <- function(y, x){
  param <- (x*y) / (x + x^2 + x*y)
  return(param)
}

augmented_parameters <- augmented_restricted_model %>%
  select(term, subset, estimate) %>% 
  filter(term != "(Intercept)") %>% 
  spread(term, estimate) %>% 
  mutate(alpha = find.param(restricted_regressor_hc, restricted_regressor),
         beta = find.param(restricted_regressor, restricted_regressor_hc),
         alpha = round(alpha, 2),
         beta = round(beta, 2)) %>% 
  select(subset, alpha, beta)

classic_parameters <- restricted_model_results %>% 
  select(subset, alpha) %>% 
  drop_na() %>% 
  mutate(alpha = round(alpha, 2))

classic_parameters
augmented_parameters

estimated_parameters <- bind_rows(classic_parameters,
                                  augmented_parameters) %>% 
  separate(subset, c("subset",
                     "estimation_type",
                     "model_type"),
           sep = " ")
estimated_parameters
```


```{r, modelling}

k <- seq(from = 0, to = 100, by = 1)
calculate.k.t.1 <- function(s, n, g, d, k, alpha){
  sy <- s*k^alpha
  net_dep <- (1 - (n + g + d))*k
  k_t_1 <-  sy + net_dep
  vals <- c(sy,
            net_dep,
            k_t_1)
  names(vals) <- NULL
  return(vals)
}
s_uk <- MRW_clean %>% 
  filter(country == "United Kingdom") %>% 
  select(s)
n_g_d_uk <- MRW_clean %>% 
  filter(country == "United Kingdom") %>% 
  select(n_g_d)
alpha_uk <- 0.36


uk_k_t <- tibble(time = seq(from = 0, to = 100, by = 1))
init_k <- 0



k <- calculate.k.t.1(k = 100,
           s = s_uk,
           n = n_g_d_uk,
           g = 0,
           d = 0,
           alpha = alpha_uk)
init_matrix <- matrix(nrow = 100, ncol = 4)
init_matrix[1:100, 1] <- c(seq(from = 1, to = 100, by = 1))
for (i in 1:100){
  k <- calculate.k.t.1(k = k[[3]],
           s = s_uk,
           n = n_g_d_uk,
           g = 0,
           d = 0,
           alpha = alpha_uk)
  init_matrix[i, 2:4] <- k %>% unlist()


}

k_tbl <- init_matrix %>% as_tibble()
colnames(k_tbl) <- c("time",
                     "savings",
                     "effective_depreciation",
                     "k_t_1")
k_tbl <- k_tbl %>% 
  mutate(k_t = lag(k_t_1))
library(ggplot2)
ggplot(k_tbl,
       aes(k_t, k_t_1)) +
  geom_point() +
  geom_point(aes(k_t, savings))


```


```{r, stargazer , results='asis'}
library(latex2exp)
restricted_models %>% 
    stargazer::stargazer(type = 'html',
                       column.labels = c("Non-Oil",
                                         "Intermediate",
                                         "OECD"),
                       digits = 2,
                       omit.stat = "f",
                       df = FALSE,
                       covariate.labels = c("ln(I/Y) - ln(n + g + d)",
                                            "CONSTANT"),
                       add.lines = list(c("Implied alpha", classic_parameters$alpha)))
```

